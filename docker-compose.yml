services:
  app:
    image: ghcr.io/d3mocide/meshrf:latest
    container_name: meshrf
    ports:
      - "80:80"
    environment:
      # Hostname for reverse proxy
      - ALLOWED_HOSTS=localhost
      # Default Map Center (Portland, OR)
      - VITE_MAP_LAT=45.5152
      - VITE_MAP_LNG=-122.6784
      # UI Defaults (Runtime Configurable)
      - DEFAULT_MAP_STYLE=dark_green
      - DEFAULT_UNITS=imperial
    restart: always
    networks:
      - meshrf_net

  rf-engine:
    image: ghcr.io/d3mocide/meshrf-rf-engine:latest
    container_name: rf_engine
    environment:
      # Elevation Data Configuration
      # Using local OpenTopoData service
      - ELEVATION_API_URL=http://opentopodata:5000

      # Dataset to use: ned10m (High res US) or srtm30m (Global)
      # User must download .hgt/.tif files to ./data/opentopodata
      - ELEVATION_DATASET=${ELEVATION_DATASET:-ned10m}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    command: uvicorn server:app --host 0.0.0.0 --port 5001 --log-level warning
    volumes:
      - ./cache:/app/cache

    restart: unless-stopped
    depends_on:
      - redis
    networks:
      - meshrf_net

  rf-worker:
    image: ghcr.io/d3mocide/meshrf-rf-engine:latest
    container_name: rf_worker
    command: celery -A worker.celery_app worker --loglevel=info
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELEVATION_API_URL=http://opentopodata:5000
      - ELEVATION_DATASET=${ELEVATION_DATASET:-ned10m}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    volumes:
      - ./cache:/app/cache

    restart: unless-stopped
    depends_on:
      - rf-engine
      - redis
    networks:
      - meshrf_net

  redis:
    image: redis:alpine
    user: nobody
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - ./redis_data:/data
    restart: always
    networks:
      - meshrf_net

  opentopodata:
    image: ghcr.io/d3mocide/meshrf-opentopodata:latest
    container_name: opentopodata
    volumes:
      # Location of your .hgt/.tif files
      - ./data/opentopodata:/app/data:ro
      # Location of your config.yaml file
      - ./data/opentopodata/config.yaml:/app/config.yaml:ro
    restart: unless-stopped
    networks:
      - meshrf_net

networks:
  meshrf_net:
    driver: bridge
