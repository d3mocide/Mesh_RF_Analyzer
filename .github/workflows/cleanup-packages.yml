name: Delete Old Container Images

on:
  workflow_dispatch: # Allow manual run
  schedule:
    - cron: "0 0 * * 0" # Run weekly on Sunday at midnight

jobs:
  clean-ghcr:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Bulk Delete Untagged Images
        env:
          GITHUB_TOKEN: ${{ secrets.GHCR_DELETE_PAT }}
        run: |
          # Robust cleanup script
          # 1. Detects if owner is User or Org
          # 2. Iterates through packages: meshrf, meshrf-rf-engine, meshrf-opentopodata

          PKG_NAMES=("meshrf" "meshrf-rf-engine" "meshrf-opentopodata")
          OWNER="${{ github.repository_owner }}"

          echo "Checking owner type for: $OWNER"
          TYPE=$(gh api "users/$OWNER" --jq '.type' || echo "Organization")
          echo "Owner Type: $TYPE"

          if [[ "$TYPE" == "Organization" ]]; then
            ENDPOINT="orgs/$OWNER"
          else
            ENDPOINT="users/$OWNER"
          fi

          echo "Using endpoint base: $ENDPOINT"

          for PKG in "${PKG_NAMES[@]}"; do
            echo "----------------------------------------"
            echo "Cleaning package: $PKG"
            echo "----------------------------------------"
            
            for batch in {1..10}; do
               echo "Processing Batch $batch..."
               
               # List versions (using specific endpoint)
               # We verify 'metadata.container.tags.length == 0' to ensure safety
               IDS=$(gh api "$ENDPOINT/packages/container/$PKG/versions?per_page=100" \
                 --jq '.[] | select(.metadata.container.tags | length == 0) | .id' || echo "")
               
               if [ -z "$IDS" ]; then
                 echo "✅ No more untagged versions found for $PKG."
                 break
               fi
               
               count=0
               for ID in $IDS; do
                 echo "Deleting version ID: $ID"
                 # Capture error output
                 if ! gh api --method DELETE "$ENDPOINT/packages/container/$PKG/versions/$ID"; then
                    echo "❌ Failed to delete $ID. You may need a PAT with 'delete:packages' scope if this is a personal account."
                 else
                    ((count++))
                 fi
               done
               echo "Deleted $count images in this batch."
            done
          done
